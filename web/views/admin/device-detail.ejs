<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - <%= settings && settings.company_header ? settings.company_header : 'Alijaya Network' %></title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/style.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #06b6d4;
            --dark-color: #1e293b;
            --light-color: #f8fafc;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--light-color);
            color: var(--dark-color);
        }
        
        .sidebar {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            min-height: 100vh;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1.5rem;
            margin: 0.25rem 0;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }
        
        .sidebar .nav-link i {
            margin-right: 0.75rem;
            width: 20px;
        }
        
        .main-content {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin: 1rem;
            padding: 2rem;
        }
        
        .card {
            border: none;
            border-radius: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .btn {
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            border: none;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
        }
        
        .status-offline {
            background-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
        }
        
        .parameter-table th {
            background-color: var(--light-color);
            font-weight: 600;
            border: none;
        }
        
        .parameter-table td {
            border: none;
            border-bottom: 1px solid #e5e7eb;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 280px;
                z-index: 1050;
                transition: left 0.3s ease;
            }
            
            .sidebar.show {
                left: 0;
            }
            
            .main-content {
                margin: 0.5rem;
                padding: 1rem;
            }
            
            .mobile-menu-btn {
                display: block !important;
            }
        }
        
        .mobile-menu-btn {
            display: none;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1040;
        }
        
        .overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="btn btn-primary mobile-menu-btn position-fixed" style="top: 1rem; left: 1rem; z-index: 1060;" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>
    
    <!-- Overlay for mobile -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar" id="sidebar">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white fw-bold">
                            <i class="bi bi-wifi"></i> <%= settings && settings.company_header ? settings.company_header : 'Alijaya' %>
                        </h4>
                        <% if (user) { %>
                            <small class="text-white-50">
                                <%= (user && user.isAdmin) ? (settings && settings.footer_info ? settings.footer_info : 'Admin Panel') : 'Customer Portal' %>
                            </small>
                        <% } %>
                    </div>
                    
                    <ul class="nav flex-column">
                        <%- include('../partials/sidebar') %>
                    </ul>
                    
                    <!-- System Info -->
                    <div class="mt-4 pt-3 border-top border-light border-opacity-25">
                        <small class="text-white-50 d-block mb-2">System Info</small>
                        <div class="text-white-50 small">
                            <div class="d-flex justify-content-between">
                                <span>Uptime:</span>
                                <span id="systemUptime">-</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Memory:</span>
                                <span id="systemMemory">-</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>CPU:</span>
                                <span id="systemCPU">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Logout -->
                    <div class="mt-4 pt-3 border-top border-light border-opacity-25">
                        <form action="/auth/logout" method="POST" class="d-inline w-100">
                            <button type="submit" class="btn btn-outline-light btn-sm w-100">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </button>
                        </form>
                    </div>
                </div>
            </nav>
            
            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="main-content">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <div>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="/admin/dashboard">Dashboard</a></li>
                                    <li class="breadcrumb-item"><a href="/admin/devices">Devices</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Device Detail</li>
                                </ol>
                            </nav>
                            <h1 class="h2"><i class="bi bi-router"></i> Device Detail</h1>
                        </div>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshDevice()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="backToDevices()">
                                    <i class="bi bi-arrow-left"></i> Back to Devices
                                </button>
                            </div>
                        </div>
                    </div>

                    <% if (typeof error !== 'undefined' && error) { %>
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle"></i> <%= error %>
                        </div>
                    <% } %>

                    <% if (device) { %>
                        <%
                            const lastInform = new Date(device._lastInform);
                            const now = new Date();
                            const diffMinutes = Math.floor((now - lastInform) / (1000 * 60));
                            const isOnline = diffMinutes < 15;
                            const tags = device._tags || [];
                            const customerInfo = tags.length > 0 ? tags[0] : 'No Tag';

                            // Use deviceInfo if available, otherwise fallback to direct extraction
                            const serialNumber = deviceInfo ? deviceInfo.serialNumber : (device.InternetGatewayDevice?.DeviceInfo?.SerialNumber?._value || 'N/A');
                            const model = deviceInfo ? deviceInfo.model : (device.InternetGatewayDevice?.DeviceInfo?.ModelName?._value || 'N/A');
                            const manufacturer = deviceInfo ? deviceInfo.manufacturer : (device.InternetGatewayDevice?.DeviceInfo?.Manufacturer?._value || 'N/A');
                            const firmware = deviceInfo ? deviceInfo.firmware : (device.InternetGatewayDevice?.DeviceInfo?.SoftwareVersion?._value || 'N/A');
                            const hardwareVersion = device.InternetGatewayDevice?.DeviceInfo?.HardwareVersion?._value || 'N/A';
                        %>

                        <!-- Device Status Header -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-8">
                                                <h4 class="card-title mb-1">
                                                    <span class="status-indicator <%= isOnline ? 'status-online' : 'status-offline' %>"></span>
                                                    <%= customerInfo %>
                                                </h4>
                                                <p class="text-muted mb-0">
                                                    <strong>Device ID:</strong> <%= device._id %><br>
                                                    <strong>Serial Number:</strong> <%= serialNumber %><br>
                                                    <strong>Last Inform:</strong> <%= lastInform.toLocaleString() %>
                                                </p>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <span class="badge <%= isOnline ? 'bg-success' : 'bg-danger' %> fs-6">
                                                    <%= isOnline ? 'Online' : 'Offline' %>
                                                </span>
                                                <br><small class="text-muted">
                                                    <%= diffMinutes < 60 ? diffMinutes + ' minutes ago' : Math.floor(diffMinutes/60) + ' hours ago' %>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Device Information -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> Device Information</h5>
                                    </div>
                                    <div class="card-body">
                                        <table class="table parameter-table">
                                            <tr>
                                                <th width="40%">Manufacturer</th>
                                                <td><%= manufacturer %></td>
                                            </tr>
                                            <tr>
                                                <th>Model</th>
                                                <td><%= model %></td>
                                            </tr>
                                            <tr>
                                                <th>Hardware Version</th>
                                                <td><%= hardwareVersion %></td>
                                            </tr>
                                            <tr>
                                                <th>Firmware Version</th>
                                                <td><%= firmware %></td>
                                            </tr>
                                            <tr>
                                                <th>Serial Number</th>
                                                <td><%= serialNumber %></td>
                                            </tr>
                                            <tr>
                                                <th>Device ID</th>
                                                <td><code><%= device._id %></code></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0"><i class="bi bi-activity"></i> Connection Status</h5>
                                    </div>
                                    <div class="card-body">
                                        <table class="table parameter-table">
                                            <tr>
                                                <th width="40%">Status</th>
                                                <td>
                                                    <span class="badge <%= isOnline ? 'bg-success' : 'bg-danger' %>">
                                                        <%= isOnline ? 'Online' : 'Offline' %>
                                                    </span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Last Inform</th>
                                                <td><%= lastInform.toLocaleString() %></td>
                                            </tr>
                                            <tr>
                                                <th>Registration Time</th>
                                                <td><%= device._registered ? new Date(device._registered).toLocaleString() : 'N/A' %></td>
                                            </tr>
                                            <tr>
                                                <th>Customer Tag</th>
                                                <td>
                                                    <div class="d-flex align-items-center gap-2">
                                                        <% if (tags.length > 0) { %>
                                                            <div class="d-flex flex-wrap gap-1">
                                                                <% tags.forEach((tag, index) => { %>
                                                                    <div class="badge bg-info d-flex align-items-center gap-1">
                                                                        <span><%= tag %></span>
                                                                        <button type="button" class="btn btn-sm btn-outline-light p-0 ms-1" 
                                                                                data-tag="<%= tag %>" data-index="<%= index %>"
                                                                                onclick="editTagFromData(this)" 
                                                                                title="Edit tag">
                                                                            <i class="bi bi-pencil" style="font-size: 0.7rem;"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-sm btn-outline-light p-0 ms-1" 
                                                                                data-tag="<%= tag %>" data-index="<%= index %>"
                                                                                onclick="deleteTagFromData(this)" 
                                                                                title="Hapus tag">
                                                                            <i class="bi bi-x" style="font-size: 0.7rem;"></i>
                                                                        </button>
                                                                    </div>
                                                                <% }); %>
                                                            </div>
                                                        <% } else { %>
                                                            <span class="text-muted">No tags</span>
                                                        <% } %>
                                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewTag()">
                                                            <i class="bi bi-plus"></i> Add Tag
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <th>Connection Type</th>
                                                <td>TR-069 / CWMP</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- WiFi Management -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0"><i class="bi bi-wifi"></i> Kelola Nama WiFi (SSID)</h5>
                                    </div>
                                    <div class="card-body">
                                        <%
                                            // Get current SSID
                                            let currentSSID = 'Tidak Diketahui';
                                            if (device && device.InternetGatewayDevice?.LANDevice?.[1]?.WLANConfiguration?.[1]?.SSID?._value) {
                                                currentSSID = device.InternetGatewayDevice.LANDevice[1].WLANConfiguration[1].SSID._value;
                                            } else if (device && device.InternetGatewayDevice?.LANDevice?.['1']?.WLANConfiguration?.['1']?.SSID?._value) {
                                                currentSSID = device.InternetGatewayDevice.LANDevice['1'].WLANConfiguration['1'].SSID._value;
                                            }
                                        %>

                                        <!-- Current SSID Display -->
                                        <div class="alert alert-info mb-3">
                                            <i class="bi bi-info-circle"></i> <strong>SSID Saat Ini:</strong>
                                            <span class="text-primary fw-bold"><%= currentSSID %></span>
                                        </div>

                                        <form id="ssidForm">
                                            <div class="mb-3">
                                                <label for="newSSID" class="form-label">Nama SSID Baru</label>
                                                <input type="text" class="form-control" id="newSSID" placeholder="Masukkan nama WiFi baru" maxlength="32" required>
                                                <div class="form-text">
                                                    <i class="bi bi-info-circle"></i> SSID harus 3-32 karakter.
                                                    Jaringan 5GHz akan otomatis mendapat suffix "-5G".
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-wifi"></i> Ubah SSID
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0"><i class="bi bi-shield-lock"></i> Kelola Password WiFi</h5>
                                    </div>
                                    <div class="card-body">
                                        <%
                                            // Get current WiFi password (usually hidden for security)
                                            let currentPassword = '••••••••••';
                                            let passwordStatus = 'Tersembunyi untuk keamanan';

                                            // Check if password exists (we don't show actual password for security)
                                            if (device && device.InternetGatewayDevice?.LANDevice?.[1]?.WLANConfiguration?.[1]?.KeyPassphrase?._value) {
                                                passwordStatus = 'Password sudah diatur';
                                            } else if (device && device.InternetGatewayDevice?.LANDevice?.['1']?.WLANConfiguration?.['1']?.KeyPassphrase?._value) {
                                                passwordStatus = 'Password sudah diatur';
                                            }
                                        %>

                                        <!-- Current Password Status Display -->
                                        <div class="alert alert-warning mb-3">
                                            <i class="bi bi-shield-lock"></i> <strong>Status Password:</strong>
                                            <span class="text-dark"><%= passwordStatus %></span>
                                        </div>

                                        <form id="passwordForm">
                                            <div class="mb-3">
                                                <label for="newPassword" class="form-label">Password WiFi Baru</label>
                                                <div class="input-group">
                                                    <input type="password" class="form-control" id="newPassword" placeholder="Masukkan password baru" minlength="8" maxlength="63" required>
                                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility()">
                                                        <i class="bi bi-eye" id="passwordToggleIcon"></i>
                                                    </button>
                                                </div>
                                                <div class="form-text">Password harus 8-63 karakter</div>
                                            </div>
                                            <button type="submit" class="btn btn-warning">
                                                <i class="bi bi-shield-lock"></i> Ubah Password
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Device Actions -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0"><i class="bi bi-tools"></i> Device Actions</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row justify-content-center">
                                            <div class="col-md-4 mb-3">
                                                <button class="btn btn-outline-warning w-100" onclick="restartDevice()">
                                                    <i class="bi bi-arrow-clockwise"></i><br>
                                                    <span>Restart Device</span>
                                                </button>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <button class="btn btn-outline-info w-100" onclick="refreshParameters()">
                                                    <i class="bi bi-arrow-clockwise"></i><br>
                                                    <span>Refresh Parameters</span>
                                                </button>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <button class="btn btn-outline-secondary w-100" onclick="downloadConfig()">
                                                    <i class="bi bi-download"></i><br>
                                                    <span>Download Config</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    <% } else { %>
                        <div class="text-center py-5">
                            <i class="bi bi-exclamation-circle fs-1 text-muted"></i>
                            <h3 class="text-muted mt-3">Device Not Found</h3>
                            <p class="text-muted">The requested device could not be found.</p>
                            <a href="/admin/devices" class="btn btn-primary">
                                <i class="bi bi-arrow-left"></i> Back to Devices
                            </a>
                        </div>
                    <% } %>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="/js/app.js"></script>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        }
        
        function refreshDevice() {
            AlijayaWeb.showToast('Refreshing device information...', 'info');
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        function backToDevices() {
            window.location.href = '/admin/devices';
        }
        
        function restartDevice() {
            if (confirm('Are you sure you want to restart this device? This will temporarily disconnect the customer.')) {
                AlijayaWeb.showToast('Restarting device...', 'warning');
                
                fetch(`/admin/api/devices/<%= device ? device._id : '' %>/restart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        AlijayaWeb.showToast('Device restart initiated successfully', 'success');
                    } else {
                        AlijayaWeb.showToast('Failed to restart device: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    AlijayaWeb.showToast('Error restarting device: ' + error.message, 'error');
                });
            }
        }
        

        
        function refreshParameters() {
            AlijayaWeb.showToast('Refreshing device parameters...', 'info');
            // Implementation for parameter refresh
            setTimeout(() => {
                AlijayaWeb.showToast('Parameters refreshed successfully', 'success');
            }, 2000);
        }
        
        function downloadConfig() {
            AlijayaWeb.showToast('Downloading device configuration...', 'info');
            // Implementation for config download
            setTimeout(() => {
                AlijayaWeb.showToast('Configuration download started', 'success');
            }, 1000);
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('newPassword');
            const toggleIcon = document.getElementById('passwordToggleIcon');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'bi bi-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'bi bi-eye';
            }
        }

        // Handle SSID form submission
        document.getElementById('ssidForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const newSSID = document.getElementById('newSSID').value.trim();

            if (!newSSID || newSSID.length < 3 || newSSID.length > 32) {
                AlijayaWeb.showToast('SSID harus 3-32 karakter', 'error');
                return;
            }

            if (confirm(`Apakah Anda yakin ingin mengubah SSID WiFi menjadi "${newSSID}"?`)) {
                AlijayaWeb.showToast('Mengubah SSID WiFi...', 'info');

                // Get phone number from customer tag
                const phoneNumber = '<%= device && device._tags && device._tags.length > 0 ? device._tags[0] : "" %>';

                fetch('/admin/api/wifi/change-ssid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber: phoneNumber,
                        newSSID: newSSID
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        AlijayaWeb.showToast('SSID WiFi berhasil diubah', 'success');
                        document.getElementById('newSSID').value = '';
                        // Refresh page after 2 seconds to show updated SSID
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        AlijayaWeb.showToast('Gagal mengubah SSID: ' + (data.error || 'Error tidak diketahui'), 'error');
                    }
                })
                .catch(error => {
                    AlijayaWeb.showToast('Error mengubah SSID: ' + error.message, 'error');
                });
            }
        });

        // Handle password form submission
        document.getElementById('passwordForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;

            if (!newPassword || newPassword.length < 8 || newPassword.length > 63) {
                AlijayaWeb.showToast('Password harus 8-63 karakter', 'error');
                return;
            }

            if (confirm('Apakah Anda yakin ingin mengubah password WiFi?')) {
                AlijayaWeb.showToast('Mengubah password WiFi...', 'info');

                // Get phone number from customer tag
                const phoneNumber = '<%= device && device._tags && device._tags.length > 0 ? device._tags[0] : "" %>';

                fetch('/admin/api/wifi/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phoneNumber: phoneNumber,
                        newPassword: newPassword
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        AlijayaWeb.showToast('Password WiFi berhasil diubah', 'success');
                        document.getElementById('newPassword').value = '';
                        // Refresh page after 2 seconds to show updated status
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        AlijayaWeb.showToast('Gagal mengubah password: ' + (data.error || 'Error tidak diketahui'), 'error');
                    }
                })
                .catch(error => {
                    AlijayaWeb.showToast('Error mengubah password: ' + error.message, 'error');
                });
            }
        });

        // Update system info in sidebar
        function updateSystemInfo() {
            fetch('/admin/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('systemUptime').textContent = '15d 8h';
                    document.getElementById('systemMemory').textContent = '45%';
                    document.getElementById('systemCPU').textContent = '25%';
                })
                .catch(error => {
                    console.error('Error updating system info:', error);
                });
        }

        // Initial load
        updateSystemInfo();

        // Auto-refresh every 30 seconds
        setInterval(() => {
            updateSystemInfo();
        }, 30000);

        let currentTagIndex = -1;
        let currentTagValue = '';
        let isEditMode = false;

        // Function untuk menambah tag baru
        function addNewTag() {
            isEditMode = false;
            currentTagIndex = -1;
            currentTagValue = '';
            document.getElementById('tagModalTitle').textContent = 'Add Customer Tag';
            document.getElementById('tagValue').value = '';
            document.getElementById('tagValue').placeholder = 'Masukkan nomor pelanggan atau tag';
            
            const modal = new bootstrap.Modal(document.getElementById('tagModal'));
            modal.show();
        }

        // Function untuk edit tag
        function editTag(tag, index) {
            isEditMode = true;
            currentTagIndex = index;
            currentTagValue = tag;
            document.getElementById('tagModalTitle').textContent = 'Edit Customer Tag';
            document.getElementById('tagValue').value = tag;
            document.getElementById('tagValue').placeholder = 'Masukkan nomor pelanggan atau tag';
            
            const modal = new bootstrap.Modal(document.getElementById('tagModal'));
            modal.show();
        }

        // Function untuk hapus tag
        function deleteTag(tag, index) {
            if (confirm(`Apakah Anda yakin ingin menghapus tag "${tag}"?`)) {
                AlijayaWeb.showToast('Menghapus tag...', 'info');
                
                const deviceId = '<%= device._id %>';
                
                fetch('/admin/api/devices/' + encodeURIComponent(deviceId) + '/tags/' + encodeURIComponent(tag), {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        AlijayaWeb.showToast('Tag berhasil dihapus', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        AlijayaWeb.showToast('Gagal menghapus tag: ' + (data.error || 'Error tidak diketahui'), 'error');
                    }
                })
                .catch(error => {
                    AlijayaWeb.showToast('Error menghapus tag: ' + error.message, 'error');
                });
            }
        }

        // Function untuk menyimpan tag
        function saveTag() {
            const tagValue = document.getElementById('tagValue').value.trim();
            
            if (!tagValue) {
                AlijayaWeb.showToast('Tag tidak boleh kosong', 'error');
                return;
            }

            const deviceId = '<%= device._id %>';
            const action = isEditMode ? 'mengubah' : 'menambahkan';
            
            AlijayaWeb.showToast(`${action} tag...`, 'info');
            
            const url = isEditMode 
                ? `/admin/api/devices/${encodeURIComponent(deviceId)}/tags/${encodeURIComponent(currentTagValue)}`
                : `/admin/api/devices/${encodeURIComponent(deviceId)}/tags`;
            
            const method = isEditMode ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tag: tagValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    AlijayaWeb.showToast(`Tag berhasil ${isEditMode ? 'diubah' : 'ditambahkan'}`, 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('tagModal'));
                    modal.hide();
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    AlijayaWeb.showToast(`Gagal ${action} tag: ` + (data.error || 'Error tidak diketahui'), 'error');
                }
            })
            .catch(error => {
                AlijayaWeb.showToast(`Error ${action} tag: ` + error.message, 'error');
            });
        }

        function editTagFromData(button) {
            const tag = button.getAttribute('data-tag');
            const index = parseInt(button.getAttribute('data-index'));
            editTag(tag, index);
        }

        function deleteTagFromData(button) {
            const tag = button.getAttribute('data-tag');
            const index = parseInt(button.getAttribute('data-index'));
            deleteTag(tag, index);
        }
    </script>

    <!-- Modal untuk Add/Edit Tag -->
    <div class="modal fade" id="tagModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tagModalTitle">Add Customer Tag</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="tagForm">
                        <div class="mb-3">
                            <label for="tagValue" class="form-label">Customer Tag</label>
                            <input type="text" class="form-control" id="tagValue" 
                                   placeholder="Masukkan nomor pelanggan atau tag" required>
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i> 
                                Masukkan nomor telepon pelanggan (contoh: 6281234567890) atau tag kustom
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTag()">Save</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
